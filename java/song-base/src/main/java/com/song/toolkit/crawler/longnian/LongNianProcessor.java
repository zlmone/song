package com.song.toolkit.crawler.longnian;import com.song.lang.StringHelper;import com.song.net.UrlHelper;import com.song.toolkit.crawler.CrawlerMovie;import com.song.toolkit.crawler.CrawlerMovieProcessor;import com.song.toolkit.serializer.SerializerFactory;import com.song.toolkit.web.JsoupHelper;import org.jsoup.nodes.Document;import org.jsoup.nodes.Element;import org.jsoup.select.Elements;import us.codecraft.webmagic.Page;import us.codecraft.webmagic.Site;import us.codecraft.webmagic.Spider;import us.codecraft.webmagic.processor.PageProcessor;import java.text.DateFormat;import java.text.ParseException;import java.text.SimpleDateFormat;import java.util.List;/** * description: * author:          song * createDate:      2017/11/12 */public class LongNianProcessor extends CrawlerMovieProcessor implements PageProcessor {    private Site site;    public LongNianProcessor() {        site = Site.me().setRetryTimes(3).setSleepTime(1000);    }    public void process(Page page) {        String url = page.getRequest().getUrl();        Document doc = page.getHtml().getDocument();        if (url.contains("a/zp/index.html")) {            //主页面分析            Elements elements = doc.select("div.mnewest li");            for (Element element : elements) {                Element link=element.select("span.stitle a").first();                String href = JsoupHelper.attr(link, "href");                String title = JsoupHelper.attr(link, "title");                String date=JsoupHelper.text(element.select("span.wp_time").first());                String contentUrl = UrlHelper.combine(getDomain(), href);                DateFormat df = new SimpleDateFormat("yyyy-MM-dd");                try {                    if(df.parse(date).getTime()>=df.parse("2017-12-12").getTime()){                        page.addTargetRequest(contentUrl);                    }                } catch (ParseException e) {                    e.printStackTrace();                }            }        } else {            //内容页分析            Element element = doc.select("div.pagecon").first();            Element titleElement = doc.select("font[color='#cacaca']").first();            String text = JsoupHelper.text(element);            if (!StringHelper.isEmpty(text)) {                String title = JsoupHelper.text(titleElement);                String downloadUrl = text.split("：")[1];                if (!StringHelper.isEmpty(downloadUrl)) {                    //添加下载资源                    CrawlerMovie movie = new CrawlerMovie();                    movie.setDownloadUrl(downloadUrl);                    movie.setUrl(url);                    movie.setTitle(title);                    this.movies.add(movie);                }            }        }    }    public Site getSite() {        return site;    }    public static void main(String[] args) {        String domain = "http://bbs.my9200.com";        LongNianProcessor processor = new LongNianProcessor();        processor.setDomain(domain);        Spider spider = Spider.create(processor);        String url = UrlHelper.combine(domain, "a/zp/index.html");        spider.addUrl(url);        spider.thread(1).run();        List<CrawlerMovie> movies = processor.getMovies();        System.out.println("");        System.out.println("");        System.out.println("");        for (CrawlerMovie movie : movies) {            System.out.println(movie.getDownloadUrl());           // System.out.println(movie.getTitle());        }        //System.out.println(SerializerFactory.getJSONInstance().toString(movies));        //download history 20171111    }}